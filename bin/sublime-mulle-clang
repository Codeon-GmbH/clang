#! /bin/sh
[ "${TRACE}" = "YES" ] && set -x && : "$0" "$@"


GENERATOR="Sublime Text 2 - Ninja"
BUILD_DIR="build"
PREFIX="`pwd -P`"

PATH="${PREFIX}/${BUILD_DIR}/llvm.d/bin:$PATH"

CONFIGURATION="${1:-Release}"
[ $# -ne 0 ] && shift
DIR="${1:-${BUILD_DIR}/mulle-clang-sublime.d}"
[ $# -ne 0 ] && shift
SRC="${1:-src/mulle-clang}"
[ $# -ne 0 ] && shift



fail()
{
   echo "$*" >&2
   exit 1
}


get_mulle_clang_version()
{
   local src="$1"

   if [ ! -d "${src}" ]
   then
      fail "mulle-clang not downloaded yet"
   fi

   if [ ! -f "${src}/install-mulle-clang.sh" ]
   then
      fail "No MULLE_CLANG_VERSION version found in \"${src}\""
   fi

   grep MULLE_CLANG_VERSION "${src}/install-mulle-clang.sh" | head -1 | sed 's/.*\"\(.*\)\"/\1/'
}


get_runtime_load_version()
{
   local src="$1"

   if [ ! -f "${src}/lib/CodeGen/CGObjCMulleRuntime.cpp" ]
   then
      fail "\"CGObjCMulleRuntime.cpp\" not found in \"${src}/lib/CodeGen\""
   fi

   grep COMPATIBLE_MULLE_OBJC_RUNTIME_LOAD_VERSION "${src}/lib/CodeGen/CGObjCMulleRuntime.cpp" \
    | head -1 \
    | awk '{ print $3 }'
}


get_clang_vendor()
{
   local src

   src="$1"

   local compiler_version
   local runtime_load_version

   compiler_version="`get_mulle_clang_version "${src}"`"
   if [ -z "${compiler_version}" ]
   then
      fail "Could not determine mulle-clang version"
   fi

   runtime_load_version="`get_runtime_load_version "${src}"`"
   if [ -z "${runtime_load_version}" ]
   then
      fail "Could not determine runtime load version"
   fi

   echo "mulle-clang ${compiler_version} (runtime-load-version: `eval echo ${runtime_load_version}`)"
}



CLANG_VENDOR="`get_clang_vendor "${SRC}"`"
MULLE_CLANG_INSTALL_PREFIX="$PREFIX"


# different builds for OS Versions on OS X

mkdir -p "${DIR}" > /dev/null
(
   cd "${DIR}"

   cmake -DWITH_POLLY=OFF \
         -DCLANG_VENDOR="${CLANG_VENDOR}" \
         -DCMAKE_INSTALL_PREFIX="${MULLE_CLANG_INSTALL_PREFIX}" \
         -DCMAKE_BUILD_TYPE="${CONFIGURATION}" -G "${GENERATOR}" "../../${SRC}"

   if [ $? -ne 0 ]
   then
      exit 1
   fi
) || exit 1

echo "ln -sf ${PREFIX}/${DIR}/${CONFIGURATION}/bin/clang /usr/local/bin/mulle-clang"
ln -sf "${PREFIX}/${DIR}/${CONFIGURATION}/bin/clang" "/usr/local/bin/mulle-clang"

echo "ln -sf ${PREFIX}/${DIR}/bin/scan-build /usr/local/bin/mulle-scan-build"
ln -sf "${PREFIX}/${DIR}/bin/scan-build" "/usr/local/bin/mulle-scan-build"

echo ln -sf "${DIR}/Clang.xcodeproj"
ln -sf "${DIR}/Clang.xcodeproj"
